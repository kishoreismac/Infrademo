name: Infra PR Security Pipeline

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    # ------------------------
    # Checkout
    # ------------------------
    - uses: actions/checkout@v4

    # ------------------------
    # Secrets
    # ------------------------
    # - name: Gitleaks Scan
    #   uses: gitleaks/gitleaks-action@v2
    #   with:
    #     fail: true

    - name: Install Gitleaks
      run: |
        curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz -o gitleaks.tar.gz
        tar -xzf gitleaks.tar.gz
        sudo mv gitleaks /usr/local/bin/

    - name: Run Gitleaks (SARIF)
      run: |
        gitleaks detect \
          --source . \
          --no-git \
          --redact \
          --report-format sarif \
          --report-path gitleaks.sarif \
          --exit-code 0

    - name: Upload Gitleaks SARIF
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: gitleaks.sarif




    # ------------------------
    # Terraform
    # ------------------------
    - uses: hashicorp/setup-terraform@v3

    # - name: Terraform Format
    #   run: terraform fmt -check -recursive

    - name: Terraform Init
      run: terraform init -backend=false

    - name: Terraform Validate
      run: terraform validate

    # ------------------------
    # tfsec → SARIF
    # ------------------------
   
   # ------------------------
# Install tfsec
# ------------------------
    - name: Install tfsec
      run: |
        TFSEC_VERSION="v1.28.4"
        curl -sSL https://github.com/aquasecurity/tfsec/releases/download/${TFSEC_VERSION}/tfsec-linux-amd64 -o tfsec
        chmod +x tfsec
        sudo mv tfsec /usr/local/bin/


    # ------------------------
    # Run tfsec (non-blocking)
    # ------------------------
    - name: Run tfsec
      continue-on-error: true
      run: |
        mkdir -p reports
        tfsec . \
          --format sarif \
          --out reports/tfsec.sarif || true

        echo "tfsec output:"
        ls -l reports

    # ------------------------
    # Upload tfsec SARIF
    # ------------------------
    - name: Upload tfsec results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: reports/tfsec.sarif

   
    # - name: tfsec scan
    #   continue-on-error: true
    #   uses: aquasecurity/tfsec-action@v1.0.3
    #   with:
    #     format: sarif
    #     output: tfsec.sarif

    # - name: Upload tfsec results
    #   uses: github/codeql-action/upload-sarif@v3
    #   with:
    #     sarif_file: tfsec.sarif

    # ------------------------
# # tfsec (Non-blocking + SARIF)
# # ------------------------
#     - name: Run tfsec
#       continue-on-error: true
#       run: |
#         mkdir -p reports
#         tfsec . \
#           --format sarif \
#           --out reports/tfsec.sarif \
#           --no-color || true

#     - name: Debug - list reports
#       run: ls -l reports

#     - name: Upload tfsec SARIF
#       uses: github/codeql-action/upload-sarif@v3
#       with:
#         sarif_file: reports/tfsec.sarif


    # ------------------------
    # Checkov → SARIF
    # ------------------------
    # - name: Checkov Scan
    #   continue-on-error: true
    #   uses: bridgecrewio/checkov-action@v12
    #   with:
    #     output_format: sarif
    #     output_file_path: checkov.sarif

    # - name: Upload Checkov results
    #   uses: github/codeql-action/upload-sarif@v3
    #   with:
    #     sarif_file: checkov.sarif

    # - name: Run Checkov
    #   uses: bridgecrewio/checkov-action@v12
    #   with:
    #     directory: .
    #     framework: terraform
    #     output: sarif
    #     soft_fail: true

    # - name: Upload Checkov results
    #   uses: github/codeql-action/upload-sarif@v3
    #   with:
    #     sarif_file: results.sarif

    # - name: Run Checkov
    #   continue-on-error: true
    #   run: |
    #     mkdir -p reports
    #     checkov -d . -o sarif --output-file-path reports/checkov.sarif

    # - name: Upload Checkov SARIF
    #   uses: github/codeql-action/upload-sarif@v3
    #   with:
    #     sarif_file: reports/checkov.sarif

    - name: Install Checkov
      run: |
        pip install checkov

    - name: Run Checkov
      continue-on-error: true
      run: |
        mkdir -p reports

        checkov -d . \
          --framework terraform \
          --output sarif \
          --output-file-path reports/checkov.sarif || true

        echo "Checkov output:"
        ls -l reports

    - name: Upload Checkov results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: reports/checkov.sarif





    # ------------------------
    # Trivy → SARIF
    # ------------------------
    # - name: Trivy IaC Scan
    #   continue-on-error: true
    #   uses: aquasecurity/trivy-action@master
    #   with:
    #     scan-type: config
    #     format: sarif
    #     output: trivy.sarif

    # - name: Upload Trivy results
    #   uses: github/codeql-action/upload-sarif@v3
    #   with:
    #     sarif_file: trivy.sarif

  # 4️⃣ TRIVY – Terraform config scan (NO Docker)
    # - name: Run Trivy (Terraform)
    #   uses: aquasecurity/trivy-action@0.20.0
    #   with:
    #     scan-type: config
    #     scan-ref: .
    #     format: sarif
    #     output: trivy.sarif
    #     severity: CRITICAL,HIGH

    # - name: Upload Trivy results
    #   uses: github/codeql-action/upload-sarif@v3
    #   with:
    #     sarif_file: trivy.sarif

    # - name: Run Trivy
    #   continue-on-error: true
    #   run: |
    #     mkdir -p reports
    #     trivy config . --format sarif --output reports/trivy.sarif

    # - name: Upload Trivy SARIF
    #   uses: github/codeql-action/upload-sarif@v3
    #   with:
    #     sarif_file: reports/trivy.sarif

    # - name: List all SARIF files
    #   run: find . -name "*.sarif"
   


    # ------------------------
    # OPA / Conftest
    # ------------------------
    # - name: Install Conftest
    #   run: |
    #     wget https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_Linux_x86_64.tar.gz
    #     tar -xzf conftest_Linux_x86_64.tar.gz
    #     sudo mv conftest /usr/local/bin/

    # - name: Terraform Plan JSON
    #   run: |
    #     terraform plan -out=tfplan
    #     terraform show -json tfplan > tfplan.json

    # - name: Run OPA Policies
    #   run: |
    #     conftest test tfplan.json --policy policy/

    # ------------------------
    # SBOM
    # ------------------------
# ------------------------
# SBOM Generation (CycloneDX)
# ------------------------
    # - name: Generate SBOM
    #   uses: CycloneDX/gh-terraform@v1
    #   with:
    #     path: .
    #     format: json

    # - name: Upload SBOM
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: terraform-sbom
    #     path: bom.json


  # ------------------------
  # CodeQL (Security Tab)
  # ------------------------
  # codeql:
  #   runs-on: ubuntu-latest
  #   permissions:
  #     security-events: write

  #   steps:
  #   - uses: actions/checkout@v4

  #   - name: Initialize CodeQL
  #     uses: github/codeql-action/init@v3
  #     with:
  #       languages: javascript, python

  #   - name: Analyze
  #     uses: github/codeql-action/analyze@v3
