# name: IaC & Secrets Security Scan

# on:
#   pull_request:
#     branches: [ "main", "develop" ]

# permissions:
#   contents: read
#   security-events: write

# jobs:
#   security-scan:
#     runs-on: ubuntu-latest

#     steps:
#       # 1️⃣ Checkout code
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       # 2️⃣ GITLEAKS – Secrets scanning
#       # - name: Run Gitleaks
#       #   uses: gitleaks/gitleaks-action@v2
#       #   with:
#       #     args: detect --source . --report-format sarif --report-path gitleaks.sarif

#       # - name: Upload Gitleaks results
#       #   uses: github/codeql-action/upload-sarif@v3
#       #   with:
#       #     sarif_file: gitleaks.sarif

#       # 3️⃣ CHECKOV – Terraform IaC scan
#       - name: Run Checkov
#         uses: bridgecrewio/checkov-action@v12
#         with:
#           directory: .
#           framework: terraform
#           output: sarif
#           soft_fail: true

#       - name: Upload Checkov results
#         uses: github/codeql-action/upload-sarif@v3
#         with:
#           sarif_file: results.sarif

#       # 4️⃣ TRIVY – Terraform config scan (NO Docker)
#       - name: Run Trivy (Terraform)
#         uses: aquasecurity/trivy-action@0.20.0
#         with:
#           scan-type: config
#           scan-ref: .
#           format: sarif
#           output: trivy.sarif
#           severity: CRITICAL,HIGH

#       - name: Upload Trivy results
#         uses: github/codeql-action/upload-sarif@v3
#         with:
#           sarif_file: trivy.sarif

name: Infra PR Security Pipeline

on:
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  infra-security:
    runs-on: ubuntu-latest

    steps:
    # ------------------------
    # Checkout
    # ------------------------
    - uses: actions/checkout@v4

    # ------------------------
    # Secrets
    # ------------------------
    # - name: Gitleaks Scan
    #   uses: gitleaks/gitleaks-action@v2
    #   with:
    #     fail: true

    - name: Install Gitleaks
      run: |
        curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz -o gitleaks.tar.gz
        tar -xzf gitleaks.tar.gz
        sudo mv gitleaks /usr/local/bin/

    - name: Run Gitleaks (SARIF)
      run: |
        gitleaks detect \
          --source . \
          --no-git \
          --redact \
          --report-format sarif \
          --report-path gitleaks.sarif \
          --exit-code 0

    - name: Upload Gitleaks SARIF
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: gitleaks.sarif




    # ------------------------
    # Terraform
    # ------------------------
    - uses: hashicorp/setup-terraform@v3

    - name: Terraform Format
      run: terraform fmt -check -recursive

    - name: Terraform Init
      run: terraform init -backend=false

    - name: Terraform Validate
      run: terraform validate

    # ------------------------
    # tfsec → SARIF
    # ------------------------
    - name: tfsec scan
      uses: aquasecurity/tfsec-action@v1.0.3
      with:
        format: sarif
        out: tfsec.sarif

    - name: Upload tfsec results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: tfsec.sarif

    # ------------------------
    # Checkov → SARIF
    # ------------------------
    - name: Checkov Scan
      uses: bridgecrewio/checkov-action@v12
      with:
        output_format: sarif
        output_file_path: checkov.sarif

    - name: Upload Checkov results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: checkov.sarif

    # ------------------------
    # Trivy → SARIF
    # ------------------------
    - name: Trivy IaC Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: config
        format: sarif
        output: trivy.sarif

    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy.sarif

    # ------------------------
    # OPA / Conftest
    # ------------------------
    # - name: Install Conftest
    #   run: |
    #     wget https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_Linux_x86_64.tar.gz
    #     tar -xzf conftest_Linux_x86_64.tar.gz
    #     sudo mv conftest /usr/local/bin/

    # - name: Terraform Plan JSON
    #   run: |
    #     terraform plan -out=tfplan
    #     terraform show -json tfplan > tfplan.json

    # - name: Run OPA Policies
    #   run: |
    #     conftest test tfplan.json --policy policy/

    # ------------------------
    # SBOM
    # ------------------------
# ------------------------
# SBOM Generation (CycloneDX)
# ------------------------
    # - name: Generate SBOM
    #   uses: CycloneDX/gh-terraform@v1
    #   with:
    #     path: .
    #     format: json

    # - name: Upload SBOM
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: terraform-sbom
    #     path: bom.json


  # ------------------------
  # CodeQL (Security Tab)
  # ------------------------
  # codeql:
  #   runs-on: ubuntu-latest
  #   permissions:
  #     security-events: write

  #   steps:
  #   - uses: actions/checkout@v4

  #   - name: Initialize CodeQL
  #     uses: github/codeql-action/init@v3
  #     with:
  #       languages: javascript, python

  #   - name: Analyze
  #     uses: github/codeql-action/analyze@v3
